geom_errorbar(width = 0.2) +
ggpubr::theme_pubr() +
theme(plot.title = element_text(hjust = 0.5),
panel.grid = element_blank())  +
labs(x="Rank Order",y="Diff. of pred. regulatory effects\n(rare vs common)",color="Context") +
scale_color_manual(values=c("Fetal brain neurons" = "#E0CA70",
"Adult brain" = "#483FA3",
"Fetal brain non-neurons" = "#4D3B3B",
"Fetal heart" = "#FF8C69",
"Adult heart" = "#B30606"
))
pdf(paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/FinalAnalysis/plots/",prefix,".2.pdf"),width = 8.6,height=3.3)
print(g)
dev.off()
#################################
g = ggplot(df, aes(y = Estimate,
x=reorder(context_v2,Estimate,median),
fill=context_v2)) +
geom_violin() +
geom_point(size=rel(0.7)) +
coord_flip() +
ggpubr::theme_pubr() +
labs(y="Diff. of pred. regulatory effects\n(rare vs common)", x = "Context",
col="",shape="") +
theme(plot.title = element_text(hjust = 0.5),
strip.background=element_rect(colour="black",
fill="#EBF2E9"),
strip.text = element_text(color='black',face = 'bold'),
panel.grid = element_blank(),
axis.text.x = element_text(hjust=1,vjust=1,angle=60))  +
guides(col="none",fill="none") +
scale_shape_manual(values=c(16,17)) +
geom_vline(xintercept = 0,lty='dashed',col='red') +
scale_fill_manual(values=c("Fetal brain neurons" = "#E0CA70",
"Adult brain" = "#483FA3",
"Fetal brain non-neurons" = "#4D3B3B",
"Fetal heart" = "#FF8C69",
"Adult heart" = "#B30606"
));
pdf(paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/FinalAnalysis/plots/",prefix,".boxplots.pdf"),width = 4.7,height=4.7)
print(g)
dev.off()
}
head(Df)
head(df)
paste0("gnomADg_AF_joint_",c("afr","amr","asj","eas","fin","nfe","sas"))
library(data.table)
library(ggplot2)
f = "/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/cbp/analysis/genedist_peakonly.txt"
df = fread(f,data.table = F,stringsAsFactors = F)
df$set = factor(df$set,levels = c("Null","Specific","Multiple","Shared"))
dim(df)
head(df)
tmp = as.data.frame(cbind(aggregate(gene_distance_1_log10~set,df,mean),aggregate(gene_distance_1_log10~set,df,function(x){sd(x)/sqrt(length(x))}))[,c(1,2,4)])
colnames(tmp)[2:3] = c("Estimate","SE")
tmp$ci.low = tmp$Estimate - 1.96 * tmp$`SE`
tmp$ci.high = tmp$Estimate + 1.96 * tmp$`SE`
l=floor(10^(min(tmp$ci.low))/1000)*1000
h=ceiling(10^(max(tmp$ci.high))/1000)*1000
rng = seq(l,h,by=floor(((h - l) / 5)/1000)*1000)
rng = c(0,1000,5000,10000,25000,50000,75000)
tmp
fwrite(tmp,"/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/Mapping the regulatory effects of common and rare non-coding variants across cellular and developmental contexts in the brain and heart REVISION3/SourceData/1c.csv",quote = F,na = "NA",sep = ',',row.names = F,col.names = T)
library(dplyr)
df$setmax = ntile(df$max_cbp, 10)
tmp = as.data.frame(cbind(aggregate(gene_distance_1_log10~setmax,df,mean),aggregate(gene_distance_1_log10~setmax,df,function(x){sd(x)/sqrt(length(x))}))[,c(1,2,4)])
colnames(tmp)[2:3] = c("Estimate","SE")
tmp$ci.low = tmp$Estimate - 1.96 * tmp$`SE`
tmp$ci.high = tmp$Estimate + 1.96 * tmp$`SE`
l=floor(10^(min(tmp$ci.low))/1000)*1000
h=ceiling(10^(max(tmp$ci.high))/1000)*1000
rng = seq(l,h,by=floor(((h - l) / 5)/1000)*1000)
rng = seq(40000,60000,by=5000)
tmp
fwrite(tmp,"/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/Mapping the regulatory effects of common and rare non-coding variants across cellular and developmental contexts in the brain and heart REVISION3/SourceData/1d.csv",quote = F,na = "NA",sep = ',',row.names = F,col.names = T)
g = ggplot(df, aes(x = df[,paste0("max_cbp")], fill = set)) +
# geom_histogram(aes(y = ..density..), position = "identity", alpha = 0.5) +
geom_histogram(aes(y = after_stat(count / sum(count))), position = "identity", alpha = 0.5,col="black") +
facet_wrap(~set,ncol = 1,scales = "free_y") +
labs(x="ChromBPnet Magnitude",
y="Frequency") +
ggpubr::theme_pubr() +
scale_fill_manual(values = c("Null" = "red", "Specific" = "black" , "Multiple" = "#79CDF7", "Shared" = "#FDE725FF")) +
theme(legend.position = "none")+ # remove legend
theme(strip.text.x = element_text(size = rel(1.1), color = "white", face = "bold"),
strip.background = element_rect(fill="#41416B"),
axis.text.y = element_blank());g
# filtered_data <- subset(df, df$num_peakscbp >0 & df[,paste0("max_cbp")] > quantile(df[,paste0("max_cbp")],probs=0.999));
filtered_data <- subset(df, df$num_peakscbp >0)
g1 <- ggplot(filtered_data,aes(x=num_peakscbp,fill=set)) +
ggpubr::theme_pubr() +
geom_histogram(aes(y = after_stat(count / sum(count))), position = "identity", alpha = 0.5,col='black',binwidth = 1) + #,fill='#FCCC49D6') + #) +
# xlim(-1,21) +
scale_y_continuous(breaks=c(0,0.2,0.4,0.6,0.8)) +
scale_fill_manual(values = c("Null" = "red", "Specific" = "black", "Multiple" = "#79CDF7", "Shared" = "#FDE725FF")) +
theme(plot.title = element_text(hjust=0.5),legend.title = element_blank()) +
labs(x="# affected cell types",y="Frequency");
pdf(paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/FinalAnalysis/plots/num_cbp.pdf"),width = 5,height=3.3)
print(g1)
dev.off()
g1
tab = as.data.frame(as.matrix(table(df$set)))
tab$V2 = rownames(tab)
tab = tab[,c(2,1)]
colnames(tab) = c("Set","N")
rownames(tab) = NULL
tab$Set = factor(tab$Set,levels = c("Null","Specific","Multiple","Shared"))
# Create the bar plot
g=ggplot(tab, aes(x = Set, y = log10(N), fill = Set)) +
geom_col(colour = "black") +
scale_y_continuous(
breaks=c(1,2,3,4,5,6),
labels = scales::math_format(10^.x),
limits = c(0, max(log10(tab$N)))) +
# labels=c("10","100","1000","10000","100000","1000000") +
ggpubr::theme_pubr() +
labs(
x = "Cell-type-specificity",
y = "Number of Rare Variants"
) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
plot.title = element_text(hjust = 0.5),
legend.position = "none"
) +
scale_fill_manual(values = c("Null" = "red", "Specific" = "black", "Multiple" = "#79CDF7", "Shared" = "#FDE725FF"))
pdf(paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/FinalAnalysis/plots/num_cbp.set_dist.pdf"),width = 5,height=4)
print(g)
dev.off()
g
df.sub = subset(df,set%in%c("Specific","Shared") &
(df[,paste0("max_cbp")] > quantile(df[,paste0("max_cbp")],probs=0.99))
)
table(df.sub$set)
snps.bed.file = "~/Downloads/strongest_rv.bed"
fwrite(data.frame(df.sub$chr,df.sub$pos-1,df.sub$pos,df.sub$snp_id,0,"+"),snps.bed.file,quote = F,na = "NA",sep = '\t',row.names = F,col.names = F)
summary(lm(phylop~set,df.sub))
summary(lm(gene_distance_1_log10~set,df.sub))
g = ggplot(df.sub,aes(x=gene_distance_1_log10,fill=set)) + geom_density(alpha=0.3) + ggpubr::theme_pubr() +
labs(x="Distance to closest TSS (bp)",y="Density",fill="") +
scale_fill_manual(
values=c("black","#FDE725FF")
) +
scale_x_continuous(
breaks=c(0,1,2,3,4,5,6),
labels = scales::math_format(10^.x)) +
theme(legend.position = c(0.45,0.95),
legend.justification = c(1, 1))
g
df.sub[1,]
library(data.table)
library(ggplot2)
f = "/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/cbp/analysis/genedist_peakonly.txt"
df = fread(f,data.table = F,stringsAsFactors = F)
df$set = factor(df$set,levels = c("Null","Specific","Multiple","Shared"))
# df$gene_distance = (10^(df$gene_distance_1_log10)-1)
# Create the plot with custom colors and line types
g=ggplot(df, aes(x = gene_distance_1_log10, col = set, linetype = set)) +
stat_density(geom="line",position="identity") +
ggpubr::theme_pubr() +
scale_color_manual(values = c("Null" = "red", "Specific" = "black", "Multiple" = "#79CDF7", "Shared" = "#FDE725FF")) +
scale_linetype_manual(values = c("Null" = "dashed", "Specific" = "solid","Multiple" = "solid", "Shared" = "solid")) +
scale_x_continuous(breaks = c(1, 2, 3, 4, 5, 6), labels = scales::math_format(10^.x)) +
labs(color = "Cell-type-specificity", linetype = "Cell-type-specificity",x="Distance to closest TSS (bp)",y="Density") +
guides(color = guide_legend(override.aes = list(linetype = c("dashed", "solid", "solid", "solid"),
color = c("red", "black", "#79CDF7", "#FDE725FF"),
size = 1),nrow=2));g
# pdf("/Users/andrewmarderstein/Documents/Research/neuro-variants/output/data/cbp/analysis/plots/numcbp_genedist.density.pdf",width = 8*0.8,height=6*0.8)
pdf(paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/FinalAnalysis/plots/numcbp_genedist.density.pdf"),width = 9.5*0.6,height=6*0.6)
print(g)
dev.off()
tmp = as.data.frame(cbind(aggregate(gene_distance_1_log10~set,df,mean),aggregate(gene_distance_1_log10~set,df,function(x){sd(x)/sqrt(length(x))}))[,c(1,2,4)])
colnames(tmp)[2:3] = c("Estimate","SE")
tmp$ci.low = tmp$Estimate - 1.96 * tmp$`SE`
tmp$ci.high = tmp$Estimate + 1.96 * tmp$`SE`
l=floor(10^(min(tmp$ci.low))/1000)*1000
h=ceiling(10^(max(tmp$ci.high))/1000)*1000
rng = seq(l,h,by=floor(((h - l) / 5)/1000)*1000)
rng = c(0,1000,5000,10000,25000,50000,75000)
g = ggplot(tmp, aes(x = Estimate,
xmin = ci.low,
xmax = ci.high,
y = set,
col=set)) +
geom_point() +
geom_errorbarh(height = 0.4) +
theme_bw() +
labs(x = "Mean closest TSS distance (bp)",y="") +#, y = "Cell-type-\n-specificity") +
theme(plot.title = element_text(hjust = 0.5),
axis.title.y = element_blank(),
strip.background=element_rect(colour="black",
fill="#EBF2E9"),
strip.text = element_text(color='black',face = 'bold'),
panel.grid = element_blank(),
axis.text.x = element_text(hjust=1,vjust=1,angle=60))  +
guides(col="none") +
# scale_color_viridis_d() +
scale_color_manual(values = c("Null" = "red", "Specific" = "black", "Multiple" = "#79CDF7", "Shared" = "#FDE725FF")) +
theme(panel.border = element_rect(colour = "black", fill=NA, size=1.5)) +
scale_x_continuous(breaks=log10(c(rng)),labels = c(rng),limits = log10(c(min(rng)-1000,max(rng)+1000)));g
# pdf("/Users/andrewmarderstein/Documents/Research/neuro-variants/output/data/cbp/analysis/plots/numcbp_genedist.avg.pdf",width = 6*0.8,height=2.5*0.8)
pdf(paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/FinalAnalysis/plots/numcbp_genedist.avg.pdf"),width = 3.5,height=2)
print(g)
dev.off()
fwrite(tmp,"/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/Mapping the regulatory effects of common and rare non-coding variants across cellular and developmental contexts in the brain and heart REVISION3/SourceData/1c.csv",quote = F,na = "NA",sep = ',',row.names = F,col.names = T)
library(dplyr)
df$setmax = ntile(df$max_cbp, 10)
tmp = as.data.frame(cbind(aggregate(gene_distance_1_log10~setmax,df,mean),aggregate(gene_distance_1_log10~setmax,df,function(x){sd(x)/sqrt(length(x))}))[,c(1,2,4)])
colnames(tmp)[2:3] = c("Estimate","SE")
tmp$ci.low = tmp$Estimate - 1.96 * tmp$`SE`
tmp$ci.high = tmp$Estimate + 1.96 * tmp$`SE`
l=floor(10^(min(tmp$ci.low))/1000)*1000
h=ceiling(10^(max(tmp$ci.high))/1000)*1000
rng = seq(l,h,by=floor(((h - l) / 5)/1000)*1000)
rng = seq(40000,60000,by=5000)
tmp
# Plot with rescaled y-axis
g <- ggplot(tmp, aes(
x = Estimate,
xmin = ci.low,
xmax = ci.high,
y = (10*setmax)-5,
col = setmax
)) +
geom_point() +
geom_errorbarh(height = 5) +
theme_bw() +
labs(x = "Mean closest TSS distance (bp)", y = "Decile (%)",title = "ChromBPnet Magnitude") +
theme(
plot.title = element_text(hjust = 0.5),
axis.title.y = element_text(size = 12),
strip.background = element_rect(colour = "black", fill = "#EBF2E9"),
strip.text = element_text(color = 'black', face = 'bold'),
panel.grid = element_blank(),
axis.text.x = element_text(hjust = 1, vjust = 1, angle = 60),
panel.border = element_rect(colour = "black", fill = NA, size = 0.75)
) +
scale_color_viridis_c(option = "H") +
scale_y_continuous(
limits = c(0, 105), # Full range of 0-100
breaks = seq(0, 100, 10), # Major ticks at intervals of 10
# labels = 10*seq(0, 10, 2), # Show original setmax values as labels
labels = c(rbind(10 * seq(0, 10, 2), rep("", length(10 * seq(0, 10, 2)) - 1)))[-12], # Show original setmax values as labels
expand = c(0, 0) # Avoid extra padding
) +
# scale_x_continuous(breaks=log10(c(rng)),labels = c(rng),limits = log10(c(min(rng)-1000,max(rng)+1000))) +
scale_x_continuous(breaks=log10(c(rng)),labels = c(rng),limits = log10(c(37000,57000))) +
guides(col = "none"); g
pdf(paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/FinalAnalysis/plots/maxcbp_genedist.avg.pdf"),width = 6,height=2.5)
print(g)
dev.off()
fwrite(tmp,"/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/Mapping the regulatory effects of common and rare non-coding variants across cellular and developmental contexts in the brain and heart REVISION3/SourceData/1d.csv",quote = F,na = "NA",sep = ',',row.names = F,col.names = T)
g = ggplot(df, aes(x = df[,paste0("max_cbp")], fill = set)) +
# geom_histogram(aes(y = ..density..), position = "identity", alpha = 0.5) +
geom_histogram(aes(y = after_stat(count / sum(count))), position = "identity", alpha = 0.5,col="black") +
facet_wrap(~set,ncol = 1,scales = "free_y") +
labs(x="ChromBPnet Magnitude",
y="Frequency") +
ggpubr::theme_pubr() +
scale_fill_manual(values = c("Null" = "red", "Specific" = "black" , "Multiple" = "#79CDF7", "Shared" = "#FDE725FF")) +
theme(legend.position = "none")+ # remove legend
theme(strip.text.x = element_text(size = rel(1.1), color = "white", face = "bold"),
strip.background = element_rect(fill="#41416B"),
axis.text.y = element_blank());g
pdf(paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/FinalAnalysis/plots/cbp_vs_numcbp.pdf"),width = 5,height=7)
print(g)
dev.off()
# filtered_data <- subset(df, df$num_peakscbp >0 & df[,paste0("max_cbp")] > quantile(df[,paste0("max_cbp")],probs=0.999));
filtered_data <- subset(df, df$num_peakscbp >0)
g1 <- ggplot(filtered_data,aes(x=num_peakscbp,fill=set)) +
ggpubr::theme_pubr() +
geom_histogram(aes(y = after_stat(count / sum(count))), position = "identity", alpha = 0.5,col='black',binwidth = 1) + #,fill='#FCCC49D6') + #) +
# xlim(-1,21) +
scale_y_continuous(breaks=c(0,0.2,0.4,0.6,0.8)) +
scale_fill_manual(values = c("Null" = "red", "Specific" = "black", "Multiple" = "#79CDF7", "Shared" = "#FDE725FF")) +
theme(plot.title = element_text(hjust=0.5),legend.title = element_blank()) +
labs(x="# affected cell types",y="Frequency");
pdf(paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/FinalAnalysis/plots/num_cbp.pdf"),width = 5,height=3.3)
print(g1)
dev.off()
tab = as.data.frame(as.matrix(table(df$set)))
tab$V2 = rownames(tab)
tab = tab[,c(2,1)]
colnames(tab) = c("Set","N")
rownames(tab) = NULL
tab$Set = factor(tab$Set,levels = c("Null","Specific","Multiple","Shared"))
# Create the bar plot
g=ggplot(tab, aes(x = Set, y = log10(N), fill = Set)) +
geom_col(colour = "black") +
scale_y_continuous(
breaks=c(1,2,3,4,5,6),
labels = scales::math_format(10^.x),
limits = c(0, max(log10(tab$N)))) +
# labels=c("10","100","1000","10000","100000","1000000") +
ggpubr::theme_pubr() +
labs(
x = "Cell-type-specificity",
y = "Number of Rare Variants"
) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
plot.title = element_text(hjust = 0.5),
legend.position = "none"
) +
scale_fill_manual(values = c("Null" = "red", "Specific" = "black", "Multiple" = "#79CDF7", "Shared" = "#FDE725FF"))
pdf(paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/FinalAnalysis/plots/num_cbp.set_dist.pdf"),width = 5,height=4)
print(g)
dev.off()
df.sub = subset(df,set%in%c("Specific","Shared") &
(df[,paste0("max_cbp")] > quantile(df[,paste0("max_cbp")],probs=0.99))
)
table(df.sub$set)
snps.bed.file = "~/Downloads/strongest_rv.bed"
fwrite(data.frame(df.sub$chr,df.sub$pos-1,df.sub$pos,df.sub$snp_id,0,"+"),snps.bed.file,quote = F,na = "NA",sep = '\t',row.names = F,col.names = F)
summary(lm(phylop~set,df.sub))
summary(lm(gene_distance_1_log10~set,df.sub))
g = ggplot(df.sub,aes(x=gene_distance_1_log10,fill=set)) + geom_density(alpha=0.3) + ggpubr::theme_pubr() +
labs(x="Distance to closest TSS (bp)",y="Density",fill="") +
scale_fill_manual(
values=c("black","#FDE725FF")
) +
scale_x_continuous(
breaks=c(0,1,2,3,4,5,6),
labels = scales::math_format(10^.x)) +
theme(legend.position = c(0.45,0.95),
legend.justification = c(1, 1))
pdf(paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/FinalAnalysis/plots/specific_vs_shared.distance.pdf"),width = 3,height=4)
print(g)
dev.off()
fwrite(df.sub[,c("gene_distance_1_log10","set")],"/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/Mapping the regulatory effects of common and rare non-coding variants across cellular and developmental contexts in the brain and heart REVISION3/SourceData/1e.csv",quote = F,na = "NA",sep = ',',row.names = F,col.names = T)
df.sub[1,]
f = "/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/FinalAnalysis/top1percent_motifbreakr.txt"
results.df = fread(f,data.table = F,stringsAsFactors = F)
head(results.df)
res = merge(df.sub,results.df[,c("SNP_id","geneSymbol")],by.x="snp_id",by.y="SNP_id")
tab = table(res$set,res$geneSymbol)[c("Specific","Shared"),]
tab = t(as.matrix(tab))
tab = as.data.frame.matrix(tab)
tab$Specific = tab$Specific/length(unique(res$snp_id[res$set=="Specific"]))
tab$Shared = tab$Shared/length(unique(res$snp_id[res$set=="Shared"]))
tab$Enrich = log2(tab$Shared / (tab$Specific + 2e-100))
tab1 = subset(tab,(Shared > 0.05 | Specific > 0.05) & Enrich > 2)
tab1 = tab1[order(tab1$Shared,decreasing = T),][1:10,]
tab2 = subset(tab,(Shared > 0.05 | Specific > 0.05) & Enrich < -2)
tab2 = tab2[order(tab2$Specific,decreasing = T),][1:10,]
head(tab1)
library(dplyr)
library(tidyr)
results.df.tab.plot = rbind(tab1[1:10,],tab2[10:1,]) %>% as.data.frame()
results.df.tab.plot$gene_symbol = rownames(results.df.tab.plot)
# Prepare the data
results_long <- results.df.tab.plot[,c("Specific","Shared","gene_symbol")] %>%
gather(key = "Condition", value = "Count", -gene_symbol) %>%
mutate(Condition = factor(Condition, levels = c("Shared", "Specific")),
Count = ifelse(Condition == "Specific", -Count, Count))
# Plot
results_long$gene_symbol = factor(results_long$gene_symbol,levels=results.df.tab.plot$gene_symbol)
g = ggplot(results_long, aes(x = gene_symbol, y = Count, fill = Condition)) +
geom_bar(stat = "identity", position = "identity",width=rel(0.5),alpha=0.5) +
geom_abline(intercept=0,slope = 0,lty='dashed',col='grey') +
# coord_flip() +
scale_y_continuous(labels = abs) +
labs(y = "Proportion", x = "Transcription Factor Motif",fill="") +
ggpubr::theme_pubr() +
# theme_classic() +
# theme_minimal() +
# guides(fill="none") +
scale_fill_manual(values=c("Specific" = "black","Shared" = "#FDE725FF")) +
theme(legend.position = "top",
panel.grid.minor = element_blank(),
axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1));g
g
head(results_long)
fwrite(results_long,"/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/Mapping the regulatory effects of common and rare non-coding variants across cellular and developmental contexts in the brain and heart REVISION3/SourceData/1f.csv",quote = F,na = "NA",sep = ',',row.names = F,col.names = T)
library(data.table)
library(ggplot2)
k = 0
g = list()
for (j in 1:3) {
if (j==1) {
df = fread("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/cbp/analysis/ukb_fm_gwas_binarizedpip_enrichments.qtl.best_celltype_continuous_predictions.txt",data.table = F,stringsAsFactors = F)
} else if (j==2) {
df = fread("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/cbp/analysis/ukb_fm_gwas_binarizedpip_enrichments.meta_best_celltype_continuous_predictions.txt",data.table = F,stringsAsFactors = F)
} else if (j==3) {
df = fread("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/cbp/analysis/ukb_fm_gwas_binarizedpip_enrichments.best_celltype_continuous_predictions.txt",data.table = F,stringsAsFactors = F)
}
trait_uniq = unique(df$trait)
for (i in 1:length(trait_uniq)) {
traitName = trait_uniq[i]
df.sub = subset(df,trait==traitName)
# Add 95% confidence intervals
df.sub$lower <- df.sub$Estimate - 1.96 * df.sub$se
df.sub$upper <- df.sub$Estimate + 1.96 * df.sub$se
# Plot
k = k + 1
g[[k]] = ggplot(df.sub, aes(x = thres, y = Estimate)) +
geom_line(size = 1) +
geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) +
labs(
x = "PIP Threshold",
y = "ChromBPNet Diff.",
title = traitName
) +
xlim(0.09,0.91) +
theme_bw() +
theme(panel.grid = element_blank(),
plot.title = element_text(hjust=0.5))
f.out = paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/cbp/analysis/plots/continuous.",traitName,".pdf")
pdf(f.out,width = 5,height = 3)
print(g[[k]])
dev.off()
}
}
g[[1]]
g[[2]]
library(cowplot)
plot_grid(g)
g[[1]]
organ="brain"
f = paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/FinalAnalysis/qtl.",organ,".cell_type_specificity.txt")
df.sub = fread(f,data.table = F,stringsAsFactors = F)
df.sub$context = c("Fetal brain","Adult brain","Fetal heart","Adult heart")
g=ggplot(df.sub,aes(x=context,y=-log10(`Pr(>|t|)`),fill=context)) +
geom_col(col='black') +
coord_flip() +
ggpubr::theme_pubr() +
labs(y="Fine-mapped Enrichment (-log10 P-values)",
x="Context",
title="# affected cell types vs. fine-mapping in different contexts") +
theme(plot.title = element_text(hjust=0.5)) +
scale_fill_manual(values=c("Fetal brain" = "#E0CA70",
"Adult brain" = "#483FA3",
"Fetal heart" = "#FF8C69",
"Adult heart" = "#B30606"
# "Fetal heart" = "#852222"
)) +
scale_y_continuous(expand = expansion(mult = 0,add=0.5)) +
guides(fill='none');g
f = paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/cbp/analysis/ukb_fm_gwas_binarizedpip_enrichments.qtl.",organ,".txt")
df=fread(f,data.table = F,stringsAsFactors = F)
# df=fread("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/cbp/analysis/ukb_fm_heartarteryqtl_binarizedpip_enrichments.txt",data.table = F,stringsAsFactors = F)
colnames(df)[5:7] = c("Std. Error","t value","Pr(<|t|)")
model_meta = fread("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/cbp/model_performance.tsv",data.table = F,stringsAsFactors = F)
df = merge(df,
model_meta[,c("dataset","celltype","dev","organ","peaks_pearsonr","peaks_spearmanr","peaks_median_jsd")],
by.x=c("dataset","cell"),
by.y = c("dataset","celltype"))
df$condition = paste(df$dev,df$organ)
# summary(lm(Estimate~condition+peaks_pearsonr+peaks_median_jsd,df))
f="/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/FinalAnalysis/adult_cluster_names.csv"
labels=fread(f,data.table = F,stringsAsFactors = F)
df = merge(df,labels[,c("Cluster","Cluster_Description")],by.x="cell",by.y="Cluster",all.x = TRUE)
df$cell_v2 = NA; df$cell_v2[!is.na(df$Cluster_Description)] = df$Cluster_Description[!is.na(df$Cluster_Description)]
f="/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/FinalAnalysis/cell_cluster_annot.csv"
labels=fread(f,data.table = F,stringsAsFactors = F)
df = merge(df,labels[,c("Cluster ID","Name (long)")],by.x="cell",by.y="Cluster ID",all.x = TRUE)
df$cell_v2[!is.na(df$`Name (long)`)] = df$`Name (long)`[!is.na(df$`Name (long)`)]
df = df[,!(colnames(df) %in% c("Name (long)","Cluster_Description"))]
df$cell_v2[is.na(df$cell_v2)]= df$cell[is.na(df$cell_v2)]
df$neuron = grepl("neuron",df$cell_v2,ignore.case = TRUE)
df$context = NA
df$context[df$dataset=="domcke_2020" & df$neuron & df$condition=="fetal brain"] = "Fetal brain neurons (Domcke)"
df$context[df$dataset=="domcke_2020" & !df$neuron & df$condition=="fetal brain"] = "Fetal brain non-neurons (Domcke)"
df$context[df$dataset=="domcke_2020" & df$condition=="fetal heart"] = "Fetal heart (Domcke)"
df$context[df$dataset=="corces_2020"] = "Adult brain (Corces)"
df$context[df$dataset=="encode_2024"] = "Adult heart (ENCODE)"
df$context[df$dataset=="ameen_2022"] = "Fetal heart (Ameen)"
df$context[df$dataset=="trevino_2021" & df$neuron & df$condition=="fetal brain"] = "Fetal brain neurons (Trevino)"
df$context[df$dataset=="trevino_2021" & !df$neuron & df$condition=="fetal brain"] = "Fetal brain non-neurons (Trevino)"
df$context_v2 = sub("\\s*\\(.*", "", df$context)
df$context_v2 = factor(df$context_v2,levels=c("Fetal brain neurons","Fetal brain non-neurons","Fetal heart","Adult heart","Adult brain"))
df$fetal_neuron = df$context_v2=="Fetal brain neurons"
# supp fig:
# pdf(paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/cbp/analysis/plots/ukb_fm_",organ,"qtl_binarizedpip_enrichments.pdf"),width = 12,height=4.8)
pdf(paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/cbp/analysis/plots/ukb_fm_",organ,"qtl_binarizedpip_enrichments.pdf"),width = 12,height=2.8)
g = ggplot(df, aes(x=reorder(cell,-1*`Pr(<|t|)`,mean),
y = -log10(`Pr(<|t|)`),
fill=context_v2)) +
geom_bar(stat='identity') +
scale_fill_manual(values=c("Fetal brain neurons" = "#E0CA70",
"Adult brain" = "#483FA3",
"Fetal brain non-neurons" = "#4D3B3B",
"Fetal heart" = "#FF8C69",
"Adult heart" = "#B30606"
)) +
ggpubr::theme_pubr() +
labs(x ="Cell type", y = expression("Fine-mapped eQTL Enrichment [-log"["10"]*italic(P)*"]"),
fill="") +
geom_hline(col='red',lty='dashed',yintercept = -log10(0.05/nrow(df))) +
theme(axis.text.x = element_blank())
print(g)
g
g
print(g)
print(g)
g = ggplot(df, aes(x=reorder(cell,-1*`Pr(<|t|)`,mean),
y = -log10(`Pr(<|t|)`),
fill=context_v2)) +
geom_bar(stat='identity') +
scale_fill_manual(values=c("Fetal brain neurons" = "#E0CA70",
"Adult brain" = "#483FA3",
"Fetal brain non-neurons" = "#4D3B3B",
"Fetal heart" = "#FF8C69",
"Adult heart" = "#B30606"
)) +
ggpubr::theme_pubr() +
labs(x ="Cell type", y = expression("Fine-mapped eQTL Enrichment [-log"["10"]*italic(P)*"]"),
fill="") +
geom_hline(col='red',lty='dashed',yintercept = -log10(0.05/nrow(df))) +
theme(axis.text.x = element_blank())
print(g)
g
