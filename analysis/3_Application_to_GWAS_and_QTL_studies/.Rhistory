guides(col="none",fill="none") +
scale_shape_manual(values=c(16,17)) +
# scale_color_viridis_d(option = "E")  +
geom_vline(xintercept = 0,lty='dashed',col='red') +
scale_fill_manual(values=c("Fetal brain neurons" = "#E0CA70",
"Adult brain" = "#483FA3",
"Fetal brain non-neurons" = "#4D3B3B",
"Fetal heart" = "#FF8C69",
"Adult heart" = "#B30606"
));
g
library(data.table)
library(ggplot2)
f=paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/cbp/analysis/phylop_vs_cbp.lm.txt")
df = fread(f,data.table = F,stringsAsFactors = F)
df1 = subset(df,model==5)
f=paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/cbp/analysis/rare_vs_common.txt")
df2 = fread(f,data.table = F,stringsAsFactors = F)
df = merge(df1,df2,by=c('cell','dataset'))
model_meta = fread("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/cbp/model_performance.tsv",data.table = F,stringsAsFactors = F)
model_meta = fread("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/cbp/model_performance.tsv",data.table = F,stringsAsFactors = F)
model_meta <- model_meta %>%
group_by(celltype, dataset) %>%
mutate(
mean_peaks_pearsonr = mean(peaks_pearsonr, na.rm = TRUE),
mean_peaks_spearmanr = mean(peaks_spearmanr, na.rm = TRUE),
mean_peaks_median_jsd = mean(peaks_median_jsd, na.rm = TRUE)
) %>%
ungroup() %>% as.data.frame()
model_meta = model_meta[!duplicated(paste(model_meta$celltype,model_meta$dataset)),]
df = merge(df,
model_meta[,c("dataset","celltype","dev","organ","mean_peaks_pearsonr","mean_peaks_spearmanr","mean_peaks_median_jsd")],
by.x=c("dataset","cell"),
by.y = c("dataset","celltype"))
df$condition = paste(df$dev,df$organ)
# summary(lm(Estimate~condition+peaks_pearsonr+peaks_median_jsd,df))
f="/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/FinalAnalysis/adult_cluster_names.csv"
labels=fread(f,data.table = F,stringsAsFactors = F)
df = merge(df,labels[,c("Cluster","Cluster_Description")],by.x="cell",by.y="Cluster",all.x = TRUE)
df$cell_v2 = NA; df$cell_v2[!is.na(df$Cluster_Description)] = df$Cluster_Description[!is.na(df$Cluster_Description)]
f="/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/FinalAnalysis/cell_cluster_annot.csv"
labels=fread(f,data.table = F,stringsAsFactors = F)
df = merge(df,labels[,c("Cluster ID","Name (long)")],by.x="cell",by.y="Cluster ID",all.x = TRUE)
df$cell_v2[!is.na(df$`Name (long)`)] = df$`Name (long)`[!is.na(df$`Name (long)`)]
df = df[,!(colnames(df) %in% c("Name (long)","Cluster_Description"))]
df$cell_v2[is.na(df$cell_v2)]= df$cell[is.na(df$cell_v2)]
df$neuron = grepl("neuron",df$cell_v2,ignore.case = TRUE)
df$context = NA
df$context[df$dataset=="domcke_2020" & df$neuron & df$condition=="fetal brain"] = "Fetal brain neurons (Domcke)"
df$context[df$dataset=="domcke_2020" & !df$neuron & df$condition=="fetal brain"] = "Fetal brain non-neurons (Domcke)"
df$context[df$dataset=="domcke_2020" & df$condition=="fetal heart"] = "Fetal heart (Domcke)"
df$context[df$dataset=="corces_2020"] = "Adult brain (Corces)"
df$context[df$dataset=="encode_2024"] = "Adult heart (ENCODE)"
df$context[df$dataset=="ameen_2022"] = "Fetal heart (Ameen)"
df$context[df$dataset=="trevino_2021" & df$neuron & df$condition=="fetal brain"] = "Fetal brain neurons (Trevino)"
df$context[df$dataset=="trevino_2021" & !df$neuron & df$condition=="fetal brain"] = "Fetal brain non-neurons (Trevino)"
df$context_v2 = sub("\\s*\\(.*", "", df$context)
df$context_v2 = factor(df$context_v2,levels=c("Fetal brain neurons","Fetal brain non-neurons","Fetal heart","Adult heart","Adult brain"))
df$fetal_neuron = df$context_v2=="Fetal brain neurons"
##############################
g = ggplot(df, aes(x = Estimate.x,
y = Estimate.y,
col=context_v2)) +
geom_point(size=rel(1.5)) +
# theme_bw() +
ggpubr::theme_pubr() +
theme(plot.title = element_text(hjust = 0.5),
# strip.background=element_rect(colour="black",
#                               fill="#EBF2E9"),
# strip.text = element_text(color='black',face = 'bold'),
panel.grid = element_blank(),
legend.position = 'right')  +
labs(x="Relationship to variant constraint",y="Diff. of pred. regulatory effects\n(rare vs common)",color="Context") +
scale_color_manual(values=c("Fetal brain neurons" = "#E0CA70",
"Adult brain" = "#483FA3",
"Fetal brain non-neurons" = "#4D3B3B",
"Fetal heart" = "#FF8C69",
"Adult heart" = "#B30606"
))
g
head(df)
tmp
df[1,]
fwrite(df[,c("Estimate.x","Estimate.y","context_v2","cell")],
"/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/Mapping the regulatory effects of common and rare non-coding variants across cellular and developmental contexts in the brain and heart REVISION3/SourceData/3e.csv",quote = F,na = "NA",sep = ',',row.names = F,col.names = T)
library(data.table)
library(ggplot2)
library(cowplot)
df = fread("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/cbp/analysis/excitatory_neurons_dev.dataset.txt",data.table = F,stringsAsFactors = F)
head(df)
df$dev_spec = ifelse(df$adult_specific,"Adult-specific","Fetal-specific")
g1=ggplot(df,aes(x=phylop,fill=dev_spec)) + geom_density(alpha=0.3) + ggpubr::theme_pubr() +
labs(x="PhyloP",y="Density",fill="") +
scale_fill_manual(
values=c("#483FA3","#E0CA70")
) +
theme(legend.position = c(0.95,0.95),
legend.justification = c(1, 1))
g2=ggplot(df,aes(x=abs_logfc.mean.fetal_brain.Excitatory_neurons.domcke_2020,fill=dev_spec)) + geom_density(alpha=0.3) + ggpubr::theme_pubr() +
labs(x="Fetal excitatory neurons chromBPnet",y="Density",fill="") +
scale_fill_manual(
values=c("#483FA3","#E0CA70")
) +
theme(legend.position = c(0.95,0.95),
legend.justification = c(1, 1))
g3=ggplot(df,aes(x=abs_logfc.mean.Cluster1.corces_2020,fill=dev_spec)) + geom_density(alpha=0.3) + ggpubr::theme_pubr() +
labs(x="Adult excitatory neurons chromBPnet",y="Density",fill="") +
scale_fill_manual(
values=c("#483FA3","#E0CA70")
) +
theme(legend.position = c(0.95,0.95),
legend.justification = c(1, 1))
# Align plots
aligned_plots <- align_plots(g2,g3,g1, align = "v", axis = "lr")
# Combine aligned plots in a grid
p <- plot_grid(aligned_plots[[1]], aligned_plots[[2]], aligned_plots[[3]], ncol = 1)
p
df[1,]
fwrite(df,
"/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/Mapping the regulatory effects of common and rare non-coding variants across cellular and developmental contexts in the brain and heart REVISION3/SourceData/3f.csv",quote = F,na = "NA",sep = ',',row.names = F,col.names = T)
g4=ggplot(df,aes(x=s_het_1,fill=dev_spec)) + geom_density(alpha=0.3) + ggpubr::theme_pubr() +
labs(x=expression("Gene Constraint (" * italic(s)[het]*")"),y="Density",fill="") +
scale_fill_manual(
values=c("#483FA3","#E0CA70")
) +
theme(legend.position = c(0.95,0.95),
legend.justification = c(1, 1))
g4
library(data.table)
library(dplyr)
library(tidyr)
library(tidyverse)
tmp = fread("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/data/FinalAnalysis/dev_specific_chrombpnet_motif_prop.txt",data.table = F,stringsAsFactors = F)
df_long <- tmp %>%
pivot_longer(
cols = starts_with("tf_"),  # Select columns that start with "tf_"
names_to = "condition",     # Name of the new column for the variable names
values_to = "value"         # Name of the new column for the values
)
# df_long$value = sqrt(df_long$value)
df_long <- df_long %>%
mutate(value = ifelse(condition %in% c("tf_fetal_specific_fb", "tf_adult_specific_fb"), -value, value))
df_long$condition = factor(df_long$condition,levels=c("tf_adult_specific_ab",
"tf_fetal_specific_ab",
"tf_adult_specific_fb",
"tf_fetal_specific_fb"))
# Create the plot
# Create the plot
# g = ggplot(df_long, aes(x = tf, y = value), fill = condition) +
g = ggplot(df_long, aes(x = tf, y = value, fill = condition)) +
# g = ggplot(df_long, aes(x = tf, y = sign(value) * sqrt(abs(value)), fill = condition)) +
geom_col(position = "stack", width = 0.7,col='black') +
scale_fill_manual(values = c("tf_fetal_specific_fb" = "#E0DF70","tf_fetal_specific_ab" = "#E0CA70", "tf_adult_specific_ab" = "#483FA3", "tf_adult_specific_fb" = "#292361"),
labels=c("tf_adult_specific_ab"= "Adult-specific (ab)",
"tf_adult_specific_fb"= "Adult-specific (fb)",
"tf_fetal_specific_ab" ="Fetal-specific (ab)",
"tf_fetal_specific_fb" ="Fetal-specific (fb)"
)
) +
theme_minimal(base_size = 14) +
labs(title = "",
x = "Transcription Factor Motif",
y = "Proportion",
fill = "Variant set (context)") +
theme(axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "right") +
geom_abline(slope=0,intercept = 0,lty=1,col='black') +
theme(plot.title = element_text(hjust=0.5)) +
scale_y_continuous(labels=abs);g
head(df_long)
fwrite(df_long,
"/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/Mapping the regulatory effects of common and rare non-coding variants across cellular and developmental contexts in the brain and heart REVISION3/SourceData/3g.csv",quote = F,na = "NA",sep = ',',row.names = F,col.names = T)
library(data.table)
library(ggplot2)
library(dplyr)
headdir="/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/pred/results/"
variantSet="asd"
predictor_lst = c("FLARE_fb","FLARE_heart","PHRED","phylop","abs_logfc.mean.c11.trevino_2021","gene_distance_1.log10")
f_lst = paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/pred/results/",variantSet,".",predictor_lst,".extrema.txt")
save_y_lst = list()
for (i in 1:length(f_lst)) {
f = f_lst[i]
predictor = predictor_lst[i]
save_y = fread(f,data.table = F,stringsAsFactors = F)
save_y$f = predictor
save_y_lst[[i]] = save_y
}
save_y.all.full = as.data.frame(do.call(rbind,save_y_lst))
subset(save_y.all.full,n==20) %>% arrange(desc(prop))
save_y.all = subset(save_y.all.full,n >= 10)
save_y.all = subset(save_y.all.full,n >= 0)
# Create a subset for ymin and ymax
save_y_subset <- subset(save_y.all, f == predictor_lst[1])
# Ensure that the subset data is merged with the original data
save_y.all$ymin <- save_y_subset$l
save_y.all$ymax <- save_y_subset$h
# Make plot
g = ggplot(save_y.all,
aes(x=log10(n),
y=prop)
) +
geom_ribbon(aes(ymin = ymin, ymax = ymax), fill = '#E3E0E0', alpha = 0.4) +
geom_line(aes(col=f)) +
geom_abline(slope=0,intercept = 0.4971098,col='red',lty='dashed') +
ggpubr::theme_pubr() +
labs(x="Outlier Variant Rank\n(near syndromic ASD genes)",y="Proportion of case mutations",title="",col=NULL) +
scale_x_continuous(
breaks = c(1, 2, 3),          # Positions of the breaks
labels = c("10", "100","1000")    # Corresponding labels
) +
geom_vline(xintercept = log10(16),lty=3) +
theme(plot.title = element_text(hjust=0.5),
legend.position = 'right') +
# ylim(0.4,0.8) +
scale_color_manual(labels=c(FLARE_fb = "FLARE: fetal brain",
FLARE_heart = "FLARE: heart",
abs_logfc.mean.c11.trevino_2021 = "ChromBPnet: early RG",
PHRED = "CADD",
phylop = "PhyloP",
gene_distance_1.log10 = expression(log[10]*"(TSS distance)")),
values=c(FLARE_fb = "#E0CA70",
FLARE_heart = "#B30606",
abs_logfc.mean.c11.trevino_2021 = "#555599",
PHRED = "#48C270",
phylop = "#3CC2B2",
gene_distance_1.log10 = "black"));g
save_y.all[1,]
tail(save_y.all)
dim(save_y.all)
fwrite(save_y.all,
"/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/Mapping the regulatory effects of common and rare non-coding variants across cellular and developmental contexts in the brain and heart REVISION3/SourceData/4c.csv",quote = F,na = "NA",sep = ',',row.names = F,col.names = T)
library(data.table)
f = paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/pred/results/scores_cntnap2.txt")
df = fread(f,data.table = F,stringsAsFactors = F)
df = df[,-1]
wilcox.test(df$FLARE_fb~df$Pheno)
colnames(df) = c("Pheno","FLARE-fb","FLARE-h","PhyloP","CADD","Early RG cbp","TSS distance")
library(tidyr)
df_long <- pivot_longer(df, cols = -Pheno, names_to = "Feature", values_to = "Value") %>% as.data.frame()
# Create scatterplots with jittered points using ggplot2
g = ggplot(df_long, aes(x = Pheno, y = Value, color = Pheno)) +
geom_point(position = position_jitter(width = 0.2), alpha = 0.8, size = 2) +
facet_wrap(~ Feature, scales = "free_y", nrow = 1) +
labs(title = "Non-coding variants near CNTNAP2", x = "Case Status", y = "Value") +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
plot.title = element_text(hjust = 0.5)
) +
guides(color = 'none') +
scale_color_manual(values = c("red", "black"))
# Print the plot
print(g)
head(df_long)
tail(df_long)
dim(df_long)
fwrite(df_long,
"/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/Mapping the regulatory effects of common and rare non-coding variants across cellular and developmental contexts in the brain and heart REVISION3/SourceData/4e.csv",quote = F,na = "NA",sep = ',',row.names = F,col.names = T)
library(data.table)
library(ggplot2)
library(dplyr)
headdir="/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/pred/chd_results/"
variantSet="asd"
predictor_lst = c("FLARE_fb","FLARE_heart","PHRED","phylop","abs_logfc.mean.fetal_heart.Endocardial_cells.domcke_2020","abs_logfc.mean.fetal_heart.Cardiomyocytes.domcke_2020","gene_distance_1.log10")
f_lst = paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/pred/chd_results/",predictor_lst,".extrema.txt")
save_y_lst = list()
for (i in 1:length(f_lst)) {
f = f_lst[i]
predictor = predictor_lst[i]
save_y = fread(f,data.table = F,stringsAsFactors = F)
save_y$f = predictor
save_y_lst[[i]] = save_y
}
save_y.all.full = as.data.frame(do.call(rbind,save_y_lst))
subset(save_y.all.full,n==20) %>% arrange(desc(prop))
library(data.table)
library(ggplot2)
library(dplyr)
headdir="/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/pred/chd_results/"
variantSet="asd"
predictor_lst = c("FLARE_fb","FLARE_heart","PHRED","phylop","abs_logfc.mean.fetal_heart.Endocardial_cells.domcke_2020","abs_logfc.mean.fetal_heart.Cardiomyocytes.domcke_2020","gene_distance_1.log10")
f_lst = paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/pred/chd_results/",predictor_lst,".extrema.txt")
save_y_lst = list()
for (i in 1:length(f_lst)) {
f = f_lst[i]
predictor = predictor_lst[i]
save_y = fread(f,data.table = F,stringsAsFactors = F)
save_y$f = predictor
save_y_lst[[i]] = save_y
}
save_y.all.full = as.data.frame(do.call(rbind,save_y_lst))
subset(save_y.all.full,n==20) %>% arrange(desc(prop))
save_y.all = subset(save_y.all.full,n >= 10)
save_y.all = subset(save_y.all.full,n >= 0)
# Create a subset for ymin and ymax
save_y_subset <- subset(save_y.all, f == "FLARE_heart")
# Ensure that the subset data is merged with the original data
save_y.all$ymin <- save_y_subset$l
save_y.all$ymax <- save_y_subset$h
# Make plot
g = ggplot(save_y.all,
aes(x=log10(n),
y=prop)
) +
geom_ribbon(aes(ymin = ymin, ymax = ymax), fill = '#E3E0E0', alpha = 0.4) +
geom_line(aes(col=f)) +
geom_abline(slope=0,intercept = 0.3212913,col='red',lty='dashed') +
ggpubr::theme_pubr() +
labs(x="Outlier Variant Rank\n(near CHD genes)",y="Proportion of case mutations",title="",col=NULL) +
scale_x_continuous(
breaks = c(1, 2, 3),          # Positions of the breaks
labels = c("10", "100","1000")    # Corresponding labels
) +
geom_vline(xintercept = log10(10),lty=3) +
theme(plot.title = element_text(hjust=0.5),
legend.position = 'right') +
# ylim(0.4,0.8) +
scale_color_manual(labels=c(FLARE_fb = "FLARE: fetal brain",
FLARE_heart = "FLARE: heart",
abs_logfc.mean.fetal_heart.Endocardial_cells.domcke_2020 = "ChromBPNet: Endocardial",
abs_logfc.mean.fetal_heart.Cardiomyocytes.domcke_2020 = "ChromBPNet: Cardiomyocytes",
PHRED = "CADD",
phylop = "PhyloP",
gene_distance_1.log10 = expression(log[10]*"(TSS distance)")),
values=c(FLARE_fb = "#E0CA70",
FLARE_heart = "#B30606",
abs_logfc.mean.fetal_heart.Endocardial_cells.domcke_2020 = "#955599",
abs_logfc.mean.fetal_heart.Cardiomyocytes.domcke_2020 = "#155599",
PHRED = "#48C270",
phylop = "#3CC2B2",
gene_distance_1.log10 = "black"));g
save_y.all[1,]
fwrite(save_y.all,
"/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/Mapping the regulatory effects of common and rare non-coding variants across cellular and developmental contexts in the brain and heart REVISION3/SourceData/5a.csv",quote = F,na = "NA",sep = ',',row.names = F,col.names = T)
library(data.table)
df = fread("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/rosmap/analysis/underexpression_outliers.txt",data.table = F,stringsAsFactors = F)
head(df)
subset(df,zthres==-3 & thres == 0.99)
# 1) choose the zthres with largest absolute value
z_thres_of_interest <- df$zthres[which.max(abs(df$zthres))]
# (optional) cap extreme CIs
df$h[df$h > 5.5] <- 5.5
# 2) build a named alpha map for all factor levels
z_levels <- levels(factor(df$zthres))
alpha_map <- setNames(ifelse(z_levels == as.character(z_thres_of_interest), 1, 0.3),
z_levels)
g=ggplot(df, aes(x = (1 - thres), y = or,
col = as.factor(zthres),
alpha = as.factor(zthres))) +
# ribbon only for the chosen |z| line
geom_ribbon(
data = subset(df, zthres == z_thres_of_interest),
aes(x = (1 - thres), ymin = l, ymax = h),
inherit.aes = FALSE,
fill = "grey70",
alpha = 0.19
) +
geom_line() +
ggpubr::theme_pubr() +
labs(
x = "FLARE Percentile Threshold",
y = "Odds Ratio",
col = expression('Outlier Threshold ('*italic(z)*')')
) +
# use any palette you like; viridis handles arbitrary counts nicely
scale_color_manual(values=c("black","red","blue")) +
# 3) apply the named alpha map so only the max-|z| line is fully opaque
scale_alpha_manual(values = alpha_map, guide = "none") +
geom_abline(intercept = 1, slope = 0, col = "red", lty = "dashed") +
scale_x_continuous(breaks = c(0.01, 0.05, 0.10), labels = c("1%", "5%", "10%"))
g
df[1,]
fwrite(df,
"/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/Mapping the regulatory effects of common and rare non-coding variants across cellular and developmental contexts in the brain and heart REVISION3/SourceData/5c.csv",quote = F,na = "NA",sep = ',',row.names = F,col.names = T)
fwrite(df,
"/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/Mapping the regulatory effects of common and rare non-coding variants across cellular and developmental contexts in the brain and heart REVISION3/SourceData/5c_1.csv",quote = F,na = "NA",sep = ',',row.names = F,col.names = T)
df = fread("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/rosmap/analysis/overexpression_outliers.txt",data.table = F,stringsAsFactors = F)
# df = fread("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/rosmap/analysis/underexpression_outliers.txt",data.table = F,stringsAsFactors = F)
head(df)
# 1) choose the zthres with largest absolute value
z_thres_of_interest <- df$zthres[which.max(abs(df$zthres))]
# (optional) cap extreme CIs
df$h[df$h > 5.5] <- 5.5
# 2) build a named alpha map for all factor levels
z_levels <- levels(factor(df$zthres))
alpha_map <- setNames(ifelse(z_levels == as.character(z_thres_of_interest), 1, 0.3),
z_levels)
df$zthres = factor(df$zthres,levels=rev(unique(df$zthres)))
g=ggplot(df, aes(x = (1 - thres), y = or,
col = as.factor(zthres),
alpha = as.factor(zthres))) +
# ribbon only for the chosen |z| line
geom_ribbon(
data = subset(df, zthres == z_thres_of_interest),
aes(x = (1 - thres), ymin = l, ymax = h),
inherit.aes = FALSE,
fill = "grey70",
alpha = 0.19
) +
geom_line() +
ggpubr::theme_pubr() +
labs(
x = "FLARE Percentile Threshold",
y = "Odds Ratio",
col = expression('Outlier Threshold ('*italic(z)*')')
) +
# use any palette you like; viridis handles arbitrary counts nicely
scale_color_manual(values=c("blue","red","black")) +
# 3) apply the named alpha map so only the max-|z| line is fully opaque
scale_alpha_manual(values = alpha_map, guide = "none") +
geom_abline(intercept = 1, slope = 0, col = "red", lty = "dashed") +
scale_x_continuous(breaks = c(0.01, 0.05, 0.10), labels = c("1%", "5%", "10%"))
g
fwrite(df,
"/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/Mapping the regulatory effects of common and rare non-coding variants across cellular and developmental contexts in the brain and heart REVISION3/SourceData/5c_2.csv",quote = F,na = "NA",sep = ',',row.names = F,col.names = T)
library(data.table)
df = fread("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/rosmap/analysis/chrombpnet_outliers.txt",data.table = F,stringsAsFactors = F)
df = subset(df,metric=="FLARE_ab")
# 1) choose the zthres with largest absolute value
z_thres_of_interest <- df$zthres[which.max(abs(df$zthres))]
# (optional) cap extreme CIs
df$h[df$h > 60] <- 60
# 2) build a named alpha map for all factor levels
z_levels <- levels(factor(df$zthres))
alpha_map <- setNames(ifelse(z_levels == as.character(z_thres_of_interest), 1, 0.3),
z_levels)
g=ggplot(df, aes(x = (1 - thres), y = or,
col = as.factor(zthres),
alpha = as.factor(zthres))) +
# ribbon only for the chosen |z| line
geom_ribbon(
data = subset(df, zthres == z_thres_of_interest),
aes(x = (1 - thres), ymin = l, ymax = h),
inherit.aes = FALSE,
fill = "grey70",
alpha = 0.19
) +
geom_line() +
ggpubr::theme_pubr() +
labs(
x = "FLARE Percentile Threshold",
y = "Odds Ratio",
col = expression('Outlier Threshold ('*italic(z)*')')
) +
# use any palette you like; viridis handles arbitrary counts nicely
scale_color_manual(values=c("black","red","blue")) +
# 3) apply the named alpha map so only the max-|z| line is fully opaque
scale_alpha_manual(values = alpha_map, guide = "none") +
geom_abline(intercept = 1, slope = 0, col = "red", lty = "dashed") +
scale_x_continuous(breaks = c(0.01, 0.05, 0.10), labels = c("1%", "5%", "10%")) +
ylim(0,60)
g
df[1,]
fwrite(df,
"/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/Mapping the regulatory effects of common and rare non-coding variants across cellular and developmental contexts in the brain and heart REVISION3/SourceData/5d.csv",quote = F,na = "NA",sep = ',',row.names = F,col.names = T)
library(data.table)
thres=95
context="fb"
df.lst = list();i=0; for (thres in c(95,99,999)) {
for (context in c("fb","heart")) {
i = i + 1
f = paste0("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/ldsc/results/extended3/joint-annot/Schizophrenia_PGCWave3_2022.FLARE_",context,".thres",thres,".results")
df = fread(f, data.table = F, stringsAsFactors = F)
df$thres = thres
df$context = context
df.lst[[i]] = df
}
}
df.all = as.data.frame(do.call(rbind,df.lst))
library(ggplot2)
library(dplyr)
df.all2 = subset(df.all, Category == "L2_1")
df.all2 <- df.all2 %>%
mutate(
thres = factor(thres, levels = c("95","99","999")),
lower_CI = Enrichment - 1.96 * Enrichment_std_error,
upper_CI = Enrichment + 1.96 * Enrichment_std_error,
context = recode(context, "fb" = "Fetal brain", "heart" = "Heart")
)
# optional bound
df.all2$lower_CI[df.all2$lower_CI < -1] = -1
g=ggplot(df.all2, aes(x = thres, y = Enrichment, color = context, group = context)) +
geom_line() +
geom_point() +
geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = context),
alpha = 0.2, color = NA) +
# scale_y_log10() +
scale_x_discrete(labels = c("95" = "Top 5%", "99" = "Top 1%", "999" = "Top 0.1%")) +
scale_fill_manual(values = c("Fetal brain" = "#E0CA70", "Heart" = "#B30606")) +
scale_color_manual(values = c("Fetal brain" = "#E0CA70", "Heart" = "#B30606")) +
labs(x = "FLARE Threshold", y = "Enrichment of per-SNP\nheritability (schizophrenia)",col="Context",fill="Context") +
theme_bw() +
geom_hline(yintercept = 0, col = 'red', lty = 'dashed') +
geom_hline(yintercept = 13.6, col = 'orange', lty = 'dashed') +
ggpubr::theme_pubr();g
df.all2
fwrite(df.all2,
"/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/Mapping the regulatory effects of common and rare non-coding variants across cellular and developmental contexts in the brain and heart REVISION3/SourceData/5e.csv",quote = F,na = "NA",sep = ',',row.names = F,col.names = T)
library(readr)
library(writexl)
files <- list.files("SourceData", pattern = "\\.csv$", full.names = TRUE)
data_list <- lapply(files, read_csv)
names(data_list) <- tools::file_path_sans_ext(basename(files))
write_xlsx(data_list, "SourceData.xlsx")
getwd()
files
files <- list.files("/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/Mapping the regulatory effects of common and rare non-coding variants across cellular and developmental contexts in the brain and heart REVISION3/SourceData", pattern = "\\.csv$", full.names = TRUE)
files
data_list <- lapply(files, read_csv)
names(data_list) <- tools::file_path_sans_ext(basename(files))
names(data_list)
write_xlsx(data_list, "/Users/amarderstein/Library/Mobile Documents/com~apple~CloudDocs/Documents/Research/chrombpnet_variant_effects/output/Mapping the regulatory effects of common and rare non-coding variants across cellular and developmental contexts in the brain and heart REVISION3/SourceData.xlsx")
